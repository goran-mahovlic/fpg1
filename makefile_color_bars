# =============================================================================
# Makefile for Color Bars Test (ULX3S ECP5)
# =============================================================================
# Purpose: Simple HDMI color bars test pattern (minimal design)
# Top Module: top_test_colorbars
# Project: test_colorbars
# Author: REGOC team
# Date: 2026-02-10
#
# No CPU modules - just PLL, VGA timing, HDMI conversion
# =============================================================================

# ==== Project configuration ====
PROJECT      := test_colorbars
TOP_MODULE   := top_test_colorbars
BOARD        := ulx3s

# ==== FPGA specifications (ULX3S 85F) ====
FPGA_DEVICE  := LFE5U-85F
FPGA_SIZE    := 85k
FPGA_PACKAGE := CABGA381
FPGA_SPEED   := 6
FPGA_IDCODE  := 0x41113043

# ==== Toolchain paths ====
OSS_CAD_SUITE ?= $(HOME)/Programs/oss-cad-suite

# Tools
YOSYS        := yosys
NEXTPNR      := nextpnr-ecp5
ECPPACK      := ecppack
PROGRAMMER   := openFPGALoader

# ==== Directories ====
SRC_DIR      := src
BUILD_DIR    := build
CONSTRAINTS_DIR := src

# ==== Source files ====
# SystemVerilog source
SV_FILES     := $(SRC_DIR)/ecp5pll.sv

# Verilog source - minimal set for color bars
V_FILES      := $(SRC_DIR)/clk_25_shift_pixel_cpu.v \
                $(SRC_DIR)/top_test_colorbars.v \
                $(SRC_DIR)/vga2dvid.v \
                $(SRC_DIR)/tmds_encoder.v \
                $(SRC_DIR)/fake_differential.v

# ==== Constraints ====
LPF_FILE     := $(CONSTRAINTS_DIR)/ulx3s_v317_pdp1.lpf

# ==== Output files ====
JSON_FILE    := $(BUILD_DIR)/$(PROJECT).json
CONFIG_FILE  := $(BUILD_DIR)/$(PROJECT).config
BIT_FILE     := $(BUILD_DIR)/$(PROJECT).bit

# ==== Yosys options ====
YOSYS_FLAGS  :=

# ==== nextpnr options ====
NEXTPNR_THREADS := $(shell nproc)
NEXTPNR_FLAGS := --timing-allow-fail --threads $(NEXTPNR_THREADS)

# ==== ecppack options ====
ECPPACK_FLAGS := --compress --freq 62.0

# =============================================================================
# TARGETS
# =============================================================================

.PHONY: colorbars colorbars_synth colorbars_pnr colorbars_bit colorbars_prog clean help

# Default target
all: colorbars_bit

# Creating build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# ==== SYNTHESIS (Yosys) ====
colorbars_synth: $(JSON_FILE)

$(JSON_FILE): $(SV_FILES) $(V_FILES) | $(BUILD_DIR)
	@echo "========================================"
	@echo "SYNTHESIS: $(PROJECT)"
	@echo "========================================"
	@echo "Top Module: $(TOP_MODULE)"
	@echo "SystemVerilog: $(SV_FILES)"
	@echo "Verilog: $(V_FILES)"
	@echo "========================================"
	$(YOSYS) -p "\
		read_verilog -sv $(SV_FILES); \
		read_verilog -I$(SRC_DIR) $(V_FILES); \
		hierarchy -top $(TOP_MODULE); \
		synth_ecp5 $(YOSYS_FLAGS) -json $@" \
		2>&1 | tee $(BUILD_DIR)/synth.log
	@echo "Synthesis completed: $@"

# ==== PLACE & ROUTE (nextpnr-ecp5) ====
colorbars_pnr: $(CONFIG_FILE)

$(CONFIG_FILE): $(JSON_FILE) $(LPF_FILE)
	@echo "========================================"
	@echo "PLACE & ROUTE: $(PROJECT)"
	@echo "========================================"
	$(NEXTPNR) \
		--$(FPGA_SIZE) \
		--package $(FPGA_PACKAGE) \
		--speed $(FPGA_SPEED) \
		--json $(JSON_FILE) \
		--lpf $(LPF_FILE) \
		--textcfg $@ \
		$(NEXTPNR_FLAGS) \
		2>&1 | tee $(BUILD_DIR)/pnr.log
	@echo "Place & Route completed: $@"

# ==== BITSTREAM GENERATION (ecppack) ====
colorbars_bit: $(BIT_FILE)

$(BIT_FILE): $(CONFIG_FILE)
	@echo "========================================"
	@echo "BITSTREAM: $(PROJECT)"
	@echo "========================================"
	$(ECPPACK) \
		--idcode $(FPGA_IDCODE) \
		--input $< \
		--bit $@ \
		$(ECPPACK_FLAGS)
	@echo "Bitstream generated: $@"
	@ls -lh $@

# ==== PROGRAMMING ====

# Upload to SRAM (temporary)
colorbars_prog: $(BIT_FILE)
	@echo "========================================"
	@echo "UPLOAD COLOR BARS TEST (SRAM)"
	@echo "========================================"
	$(PROGRAMMER) -b $(BOARD) $<

# Upload to FLASH (permanent)
colorbars_prog_flash: $(BIT_FILE)
	@echo "========================================"
	@echo "UPLOAD COLOR BARS TEST (FLASH)"
	@echo "========================================"
	$(PROGRAMMER) -b $(BOARD) -f $<

# ==== COMPLETE BUILD ====
colorbars: colorbars_bit
	@echo "========================================"
	@echo "Color Bars Test build completed!"
	@echo "Bitstream: $(BIT_FILE)"
	@echo "To upload: make colorbars_prog"
	@echo "========================================"

# ==== UTILITY ====

clean:
	@echo "Deleting build directory..."
	rm -rf $(BUILD_DIR)
	@echo "Done."

help:
	@echo "Color Bars Test Makefile - available targets:"
	@echo ""
	@echo "  Build:"
	@echo "  make colorbars         - Complete build (synth + pnr + bit)"
	@echo "  make colorbars_synth   - Synthesis only"
	@echo "  make colorbars_pnr     - Place & route only"
	@echo "  make colorbars_bit     - Bitstream generation only"
	@echo ""
	@echo "  Programming:"
	@echo "  make colorbars_prog    - Upload to FPGA (SRAM, temporary)"
	@echo "  make colorbars_prog_flash - Upload to FLASH (permanent)"
	@echo ""
	@echo "  Utility:"
	@echo "  make clean             - Delete build artifacts"
	@echo "  make help              - Show this help"
	@echo ""
	@echo "Example:"
	@echo "  source $(OSS_CAD_SUITE)/environment"
	@echo "  make clean colorbars colorbars_prog"

# Ensure constraints file exists
$(LPF_FILE):
	@echo "ERROR: Constraints file does not exist: $(LPF_FILE)"
	@exit 1
